#!/bin/bash

_PATH=/var/migasfree/dump

DUMP_FILE="$1"

if [ -z $DUMP_FILE ]
then
    DUMP_FILE=migasfree.sql
fi

echo "Restore '$DUMP_FILE' dump. "
ls  -la $_PATH/$DUMP_FILE

read -p "Are you sure [y/N]? "
echo

if [[ $REPLY =~ ^[Yy]$ ]] ; then

    ps aux|grep pg_dump > /dev/null
    if [ $? = 1 ] ; then
       echo "error: pg_dump is running!"
       exit 1
    fi

    echo "$POSTGRES_HOST:$POSTGRES_PORT:$POSTGRES_DB:$POSTGRES_USER:$POSTGRES_PASSWORD" > ~/.pgpass
    chmod 0600 ~/.pgpass

    echo "$(date -u) Drop Database: $POSTGRES_DB ..."   >> $_PATH/restore.log 2>&1
    echo "DROP DATABASE $POSTGRES_DB;" | su postgres -c psql -

    echo "$(date -u) Create BD ..." >> $_PATH/restore.log 2>&1
    su postgres -c "createdb --no-password -E utf8 $POSTGRES_DB"

    echo "$(date -u) Restore BD ..." >> $_PATH/restore.log 2>&1
    su postgres -c "psql --no-password -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -f $_PATH/$DUMP_FILE" -


    echo "$(date -u) Done." >> $_PATH/restore.log 2>&1
    echo "" >> $_PATH/restore.log 2>&1

fi
